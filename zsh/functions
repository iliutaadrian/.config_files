# Yazi file manager with cwd
yy() {
  local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
  yazi "$@" --cwd-file="$tmp"
  if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
    builtin cd -- "$cwd"
  fi
  rm -f -- "$tmp"
}

# Clear + tmux history
cc() {
  clear
  tmux clear-history
}

# Compression
compress() { tar -czf "${1%/}.tar.gz" "${1%/}"; }
alias decompress="tar -xzf"

# Transcode a video to 1080p
transcode-video-1080p() {
  ffmpeg -i $1 -vf scale=1920:1080 -c:v libx264 -preset fast -crf 23 -c:a copy ${1%.*}-1080p.mp4
}

# Transcode a video to 4K
transcode-video-4K() {
  ffmpeg -i $1 -c:v libx265 -preset slow -crf 24 -c:a aac -b:a 192k ${1%.*}-optimized.mp4
}

# Image conversion
img2jpg() {
  img="$1"; shift
  magick "$img" $@ -quality 95 -strip ${img%.*}-converted.jpg
}

img2jpg-small() {
  img="$1"; shift
  magick "$img" $@ -resize 1080x\> -quality 95 -strip ${img%.*}-small.jpg
}

img2jpg-medium() {
  img="$1"; shift
  magick "$img" $@ -resize 1800x\> -quality 95 -strip ${img%.*}-medium.jpg
}

img2png() {
  img="$1"; shift
  magick "$img" $@ -strip \
    -define png:compression-filter=5 \
    -define png:compression-level=9 \
    -define png:compression-strategy=1 \
    -define png:exclude-chunk=all \
    "${img%.*}-optimized.png"
}

# SSH Port Forwarding
fip() {
  [[ $# -lt 2 ]] && echo "Usage: fip <host> <port1> [port2] ..." && return 1
  local host="$1"; shift
  for port in "$@"; do
    ssh -f -N -L "$port:localhost:$port" "$host" && echo "Forwarding localhost:$port -> $host:$port"
  done
}

dip() {
  [[ $# -eq 0 ]] && echo "Usage: dip <port1> [port2] ..." && return 1
  for port in "$@"; do
    pkill -f "ssh.*-L $port:localhost:$port" && echo "Stopped forwarding port $port" || echo "No forwarding on port $port"
  done
}

lip() {
  pgrep -af "ssh.*-L [0-9]+:localhost:[0-9]+" || echo "No active forwards"
}

# Tmux dev layout with editor, ai, and terminal
nic() {
  local current_dir="${PWD}"
  local editor_pane ai_pane
  local ai="${1:-cx}"

  tmux rename-window "$(basename "$current_dir")"
  editor_pane=$(tmux display-message -p '#{pane_id}')
  tmux split-window -v -p 20 -c "$current_dir"
  tmux select-pane -t "$editor_pane"
  tmux split-window -h -p 35 -c "$current_dir"
  ai_pane=$(tmux display-message -p '#{pane_id}')
  tmux send-keys -t "$ai_pane" "$ai" C-m
  tmux send-keys -t "$editor_pane" "$EDITOR" C-m
  tmux select-pane -t "$editor_pane"
}

# Same layout as nic but each pane SSHes into homelab
nichl() {
  local host="${1:-homelab}"
  local editor_pane ai_pane

  tmux rename-window "$host"
  editor_pane=$(tmux display-message -p '#{pane_id}')
  tmux split-window -v -p 20
  tmux send-keys "ssh $host" C-m
  tmux select-pane -t "$editor_pane"
  tmux split-window -h -p 35
  ai_pane=$(tmux display-message -p '#{pane_id}')
  tmux send-keys -t "$ai_pane" "ssh -t $host 'zsh -i -c claude'" C-m
  tmux send-keys -t "$editor_pane" "ssh -t $host nvim" C-m
  tmux select-pane -t "$editor_pane"
}

unnic() {
  local dir
  dir="$(tmux display-message -p '#{pane_current_path}')"
  local old_window
  old_window="$(tmux display-message -p '#{window_id}')"
  tmux new-window -c "$dir"
  tmux kill-window -t "$old_window"
}
